require('dotenv').config();
const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const mongoose = require('mongoose');

const Gasto = require('./models/Gasto');
const Categoria = require('./models/Categoria');

const ALLOWED_GROUP_ID = "120363420189472861@g.us";

// Conex√£o com MongoDB
mongoose.connect(process.env.MONGO_URI)
    .then(() => console.log('üì¶ Conectado ao MongoDB!'))
    .catch(err => console.error('‚ùå Erro MongoDB:', err));

const client = new Client({
    authStrategy: new LocalAuth(),
    puppeteer: {
        headless: false,
        args: ['--no-sandbox', '--disable-setuid-sandbox']
    }
});

// Exibir QR Code
client.on('qr', qr => qrcode.generate(qr, { small: true }));
client.on('ready', () => console.log('‚úÖ Bot conectado ao WhatsApp!'));
client.on('disconnected', () => console.log('‚ö†Ô∏è Bot desconectado do WhatsApp!'));

// Escutar TODAS mensagens, inclusive as suas
client.on('message_create', async (message) => {
    const chat = await message.getChat();

    if (chat.id._serialized !== ALLOWED_GROUP_ID) return;

    const msg = message.body.trim().toLowerCase();
    console.log(`üì© Mensagem recebida: ${msg} (de ${message.fromMe ? "VOC√ä" : "outra pessoa"})`);

    switch (true) {
        case msg === '/help':
            message.reply(
                `üìå *Lista de comandos dispon√≠veis:*\n\n` +
                `- üìÇ /add-categoria [nome] [limite] ‚Üí Adiciona nova categoria com limite\n` +
                `- ‚ûï /add-gasto [valor] [categoria] ‚Üí Registra um gasto\n` +
                `- ‚úèÔ∏è /altera-valor-limite [categoria] [novoValor] ‚Üí Altera o limite da categoria\n` +
                `- ‚ùì /help ‚Üí Mostra esta lista de comandos\n` +
                `- üìã /listar-categorias ‚Üí Lista todas as categorias\n` +
                `- üèì /ping ‚Üí Testa se o bot est√° online\n` +
                `- üîÑ /reset-mes ‚Üí Apaga todos os gastos do m√™s\n` +
                `- üóëÔ∏è /rmv-categoria [categoria] ‚Üí Remove uma categoria\n` +
                `- üóëÔ∏è /rmv-gasto [valor] [categoria] ‚Üí Remove um gasto\n` +
                `- üìä /saldo [categoria] ‚Üí Mostra o saldo dispon√≠vel na categoria\n` +
                `- üí∞ /total ‚Üí Mostra o total de gastos\n` +
                `- üìà /total-categoria ‚Üí Lista o total gasto por *cada* categoria (com avisos)`
            );
            break;

        case msg === '/ping':
            message.reply('üèì Pong! Estou online!');
            break;

        case msg === '/total':
            const gastos = await Gasto.find();
            if (!gastos.length) {
                message.reply('‚ö†Ô∏è Nenhum gasto registrado ainda.');
            } else {
                const total = gastos.reduce((acc, g) => acc + g.valor, 0);
                message.reply(
                    `üí∞ *Resumo Geral dos Gastos*\n\n` +
                    `üí∏ Total gasto at√© agora: *R$ ${total.toFixed(2)}*`
                );
            }
            break;

        case msg === '/listar-categorias':
            {
                const categorias = await Categoria.find().sort({ nome: 1 });
                if (!categorias.length) {
                    message.reply('‚ö†Ô∏è Nenhuma categoria cadastrada.');
                } else {
                    const lista = categorias.map(c =>
                        `üìÇ *${c.nome}* ‚Üí Limite: R$ ${c.limite.toFixed(2)}`
                    ).join('\n\n');
                    message.reply(`üìã *Categorias Cadastradas:*\n\n${lista}`);
                }
            }
            break;

        case msg === '/total-categoria':
            {
                const categorias = await Categoria.find().sort({ nome: 1 });
                if (!categorias.length) {
                    message.reply('‚ö†Ô∏è Nenhuma categoria cadastrada.');
                    break;
                }

                let resposta = `üìà *Total por Categoria*\n\n`;
                for (const c of categorias) {
                    const gastosCat = await Gasto.find({ categoria: c.nome });
                    const totalGasto = gastosCat.reduce((acc, g) => acc + g.valor, 0);

                    // Emojis de status
                    let status = '‚úÖ';
                    if (totalGasto > c.limite) status = 'üö®';        // passou do limite
                    else if (totalGasto === c.limite) status = '‚ö†Ô∏è'; // atingiu exatamente

                    const diff = (c.limite - totalGasto).toFixed(2);
                    const linha =
                        `${status} *${c.nome.toUpperCase()}*\n` +
                        `üí∏ Total gasto: *R$ ${totalGasto.toFixed(2)}*\n` +
                        `üí∞ Limite: *R$ ${c.limite.toFixed(2)}*\n` +
                        (totalGasto > c.limite
                            ? `‚ùå Excedente: *R$ ${(totalGasto - c.limite).toFixed(2)}*`
                            : `üí≥ Restante: *R$ ${diff}*`);
                    resposta += linha + `\n\n`;
                }

                message.reply(resposta.trim());
            }
            break;

        case msg === '/reset-mes':
            await Gasto.deleteMany({});
            message.reply('üîÑ Todos os gastos foram resetados para este m√™s.');
            break;

        default:
            if (msg.startsWith('/add-categoria')) {
                const args = message.body.split(' ').slice(1);
                const nome = args[0];
                const limite = parseFloat(args[1]);

                if (!nome || isNaN(limite)) {
                    message.reply('‚ö†Ô∏è Uso correto: /add-categoria [nome] [limite]');
                    return;
                }

                await Categoria.create({ nome, limite });
                message.reply(`‚úÖ Categoria *${nome}* criada com limite de R$ ${limite.toFixed(2)}!`);
                return;
            }

            if (msg.startsWith('/add-gasto')) {
                const args = message.body.split(' ').slice(1);
                const valor = parseFloat(args[0]);
                const categoriaNome = args.slice(1).join(' ');

                if (isNaN(valor) || !categoriaNome) {
                    message.reply('‚ö†Ô∏è Uso correto: /add-gasto [valor] [categoria]');
                    return;
                }

                const categoria = await Categoria.findOne({ nome: categoriaNome });
                if (!categoria) {
                    message.reply(`‚ö†Ô∏è Categoria "${categoriaNome}" n√£o encontrada. Use /listar-categorias`);
                    return;
                }

                await Gasto.create({ valor, categoria: categoriaNome });

                // Calcular total gasto nessa categoria
                const gastosCategoria = await Gasto.find({ categoria: categoriaNome });
                const totalGasto = gastosCategoria.reduce((acc, g) => acc + g.valor, 0);

                message.reply(`‚úÖ Gasto de R$ ${valor.toFixed(2)} registrado em *${categoriaNome}*.`);

                // ALERTA caso ultrapasse o limite
                if (totalGasto > categoria.limite) {
                    const excedente = totalGasto - categoria.limite;
                    message.reply(
                        `üö® *${categoria.nome.toUpperCase()}*\n\n` +
                        `‚ö†Ô∏è O valor total planejado para esta categoria foi ultrapassado!!\n\n` +
                        `üí∞ Valor total: *R$ ${categoria.limite.toFixed(2)}*\n` +
                        `üí∏ Valor gasto: *R$ ${totalGasto.toFixed(2)}*\n` +
                        `‚ùå Valor excedente: *R$ ${excedente.toFixed(2)}*`
                    );
                }

                return;
            }

            if (msg.startsWith('/rmv-gasto')) {
                const args = message.body.split(' ').slice(1);
                const valor = parseFloat(args[0]);
                const categoriaNome = args.slice(1).join(' ');

                if (isNaN(valor) || !categoriaNome) {
                    message.reply('‚ö†Ô∏è Uso correto: /rmv-gasto [valor] [categoria]');
                    return;
                }

                const gasto = await Gasto.findOneAndDelete({ valor, categoria: categoriaNome });
                if (!gasto) {
                    message.reply(`‚ö†Ô∏è Gasto de R$ ${valor} na categoria "${categoriaNome}" n√£o encontrado.`);
                    return;
                }

                message.reply(`üóëÔ∏è Gasto de R$ ${valor.toFixed(2)} removido da categoria *${categoriaNome}*.`);
                return;
            }

            if (msg.startsWith('/rmv-categoria')) {
                const args = message.body.split(' ').slice(1);
                const categoriaNome = args.join(' ');

                if (!categoriaNome) {
                    message.reply('‚ö†Ô∏è Uso correto: /rmv-categoria [categoria]');
                    return;
                }

                await Categoria.findOneAndDelete({ nome: categoriaNome });
                await Gasto.deleteMany({ categoria: categoriaNome });
                message.reply(`üóëÔ∏è Categoria *${categoriaNome}* e seus gastos foram removidos.`);
                return;
            }

            if (msg.startsWith('/altera-valor-limite')) {
                const args = message.body.split(' ').slice(1);
                const categoriaNome = args[0];
                const novoValor = parseFloat(args[1]);

                if (!categoriaNome || isNaN(novoValor)) {
                    message.reply('‚ö†Ô∏è Uso correto: /altera-valor-limite [categoria] [novoValor]');
                    return;
                }

                const categoria = await Categoria.findOneAndUpdate(
                    { nome: categoriaNome },
                    { limite: novoValor },
                    { new: true }
                );

                if (!categoria) {
                    message.reply(`‚ö†Ô∏è Categoria "${categoriaNome}" n√£o encontrada.`);
                    return;
                }

                message.reply(`‚úèÔ∏è Limite da categoria *${categoriaNome}* atualizado para R$ ${novoValor.toFixed(2)}.`);
                return;
            }

            if (msg.startsWith('/saldo')) {
                const args = message.body.split(' ').slice(1);
                const categoriaNome = args.join(' ');

                if (!categoriaNome) {
                    message.reply('‚ö†Ô∏è Uso correto: /saldo [categoria]');
                    return;
                }

                const categoria = await Categoria.findOne({ nome: categoriaNome });
                if (!categoria) {
                    message.reply(`‚ö†Ô∏è Categoria "${categoriaNome}" n√£o encontrada.`);
                    return;
                }

                const gastos = await Gasto.find({ categoria: categoriaNome });
                const totalGasto = gastos.reduce((acc, g) => acc + g.valor, 0);
                const saldo = categoria.limite - totalGasto;

                message.reply(
                    `üìä *${categoria.nome.toUpperCase()}*\n\n` +
                    `üí∞ Valor total: *R$ ${categoria.limite.toFixed(2)}*\n` +
                    `üí∏ Total gasto: *R$ ${totalGasto.toFixed(2)}*\n` +
                    `üí≥ Valor restante: *R$ ${saldo.toFixed(2)}*`
                );
                return;
            }
            break;
    }
});

client.initialize();
